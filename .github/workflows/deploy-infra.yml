name: Deploy Infrastructure

on:
  push:
    branches:
      - development
      - master
    paths:
      - 'infra/**'
  pull_request:
    branches:
      - development
      - master
    paths:
      - 'infra/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - prod

permissions:
  id-token: write   # required for OIDC login
  contents: read
  pull-requests: write

env:
  TEMPLATE_FILE: infra/bicep/main.bicep
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}

jobs:
  # ── What-if preview on pull requests ────────────────────────────────────
  # PR → development: preview dev
  # PR → master:      preview test
  what-if:
    name: What-if (${{ github.base_ref == 'master' && 'test' || 'dev' }})
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    environment: ${{ github.base_ref == 'master' && 'test' || 'dev' }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set target environment
        run: |
          ENV=${{ github.base_ref == 'master' && 'test' || 'dev' }}
          echo "ENV=$ENV" >> $GITHUB_ENV
          echo "RESOURCE_GROUP=eventhub-${ENV}-rg" >> $GITHUB_ENV

      - name: Ensure resource group exists
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
              az group create --name ${{ env.RESOURCE_GROUP }} --location ${{ env.AZURE_LOCATION }}

      - name: What-if
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group what-if \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --template-file ${{ env.TEMPLATE_FILE }} \
              --parameters infra/bicep/environments/${{ env.ENV }}/main.bicepparam \
              --parameters sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }}

  # ── Deploy to dev on push to development ────────────────────────────────
  deploy-dev:
    name: Deploy – dev
    if: github.event_name == 'push' && github.ref == 'refs/heads/development'
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure resource group exists
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
              az group create --name eventhub-dev-rg --location ${{ env.AZURE_LOCATION }}

      - name: Deploy – dev
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group create \
              --resource-group eventhub-dev-rg \
              --template-file ${{ env.TEMPLATE_FILE }} \
              --parameters infra/bicep/environments/dev/main.bicepparam \
              --parameters sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }}

  # ── Deploy to test on push to master ────────────────────────────────────
  deploy-test:
    name: Deploy – test
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    environment: test
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure resource group exists
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
              az group create --name eventhub-test-rg --location ${{ env.AZURE_LOCATION }}

      - name: Deploy – test
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group create \
              --resource-group eventhub-test-rg \
              --template-file ${{ env.TEMPLATE_FILE }} \
              --parameters infra/bicep/environments/test/main.bicepparam \
              --parameters sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }}

  # ── Deploy to prod on manual trigger only ────────────────────────────────
  deploy-prod:
    name: Deploy – prod
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - name: Verify branch is master
        if: github.ref != 'refs/heads/master'
        run: |
          echo "Prod deployments must be triggered from master, not ${{ github.ref }}"
          exit 1

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure resource group exists
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
              az group create --name eventhub-prod-rg --location ${{ env.AZURE_LOCATION }}

      - name: Deploy – prod
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group create \
              --resource-group eventhub-prod-rg \
              --template-file ${{ env.TEMPLATE_FILE }} \
              --parameters infra/bicep/environments/prod/main.bicepparam \
              --parameters sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }}
