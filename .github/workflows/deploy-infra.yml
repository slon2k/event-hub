name: Deploy Infrastructure

on:
  push:
    branches:
      - development
      - master
    paths:
      - 'infra/**'
  pull_request:
    branches:
      - development
      - master
    paths:
      - 'infra/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod

permissions:
  id-token: write   # required for OIDC login
  contents: read
  pull-requests: write

env:
  TEMPLATE_FILE: infra/bicep/main.bicep
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}

jobs:
  # ── What-if preview on pull requests ────────────────────────────────────
  # PR → development: preview dev
  what-if-dev:
    name: What-if – dev
    if: github.event_name == 'pull_request' && github.base_ref == 'development'
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure resource group exists
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az group create --name eventhub-dev-rg --location ${{ env.AZURE_LOCATION }}

      - name: What-if
        uses: azure/cli@v2
        env:
          SQL_ADMIN_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group what-if \
              --resource-group eventhub-dev-rg \
              --template-file ${{ env.TEMPLATE_FILE }} \
              --parameters infra/bicep/environments/dev/main.bicepparam

  # PR → master: preview test
  what-if-test:
    name: What-if – test
    if: github.event_name == 'pull_request' && github.base_ref == 'master'
    runs-on: ubuntu-latest
    environment: test
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure resource group exists
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az group create --name eventhub-test-rg --location ${{ env.AZURE_LOCATION }}

      - name: What-if
        uses: azure/cli@v2
        env:
          SQL_ADMIN_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group what-if \
              --resource-group eventhub-test-rg \
              --template-file ${{ env.TEMPLATE_FILE }} \
              --parameters infra/bicep/environments/test/main.bicepparam

  # ── Deploy to dev on push to development ────────────────────────────────
  deploy-dev:
    name: Deploy – dev
    if: (github.event_name == 'push' && github.ref == 'refs/heads/development') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure resource group exists
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
              az group create --name eventhub-dev-rg --location ${{ env.AZURE_LOCATION }}

      - name: Deploy – dev
        uses: azure/cli@v2
        env:
          SQL_ADMIN_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group create \
              --resource-group eventhub-dev-rg \
              --template-file ${{ env.TEMPLATE_FILE }} \
              --parameters infra/bicep/environments/dev/main.bicepparam

      - name: Grant Key Vault access to managed identities
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            KV_ID=$(az keyvault list --resource-group eventhub-dev-rg --query "[0].id" -o tsv)
            ROLE="Key Vault Secrets User"

            API_PRINCIPAL=$(az webapp identity show --resource-group eventhub-dev-rg --name eventhub-dev-api --query principalId -o tsv)
            az role assignment create \
              --assignee-object-id "$API_PRINCIPAL" \
              --assignee-principal-type ServicePrincipal \
              --role "$ROLE" --scope "$KV_ID" 2>/dev/null || echo "API role assignment already exists"

            FUNC_PRINCIPAL=$(az functionapp identity show --resource-group eventhub-dev-rg --name eventhub-dev-func --query principalId -o tsv)
            az role assignment create \
              --assignee-object-id "$FUNC_PRINCIPAL" \
              --assignee-principal-type ServicePrincipal \
              --role "$ROLE" --scope "$KV_ID" 2>/dev/null || echo "Function App role assignment already exists"

  # ── Deploy to test on push to master ────────────────────────────────────
  deploy-test:
    name: Deploy – test
    if: (github.event_name == 'push' && github.ref == 'refs/heads/master') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'test')
    runs-on: ubuntu-latest
    environment: test
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure resource group exists
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
              az group create --name eventhub-test-rg --location ${{ env.AZURE_LOCATION }}

      - name: Deploy – test
        uses: azure/cli@v2
        env:
          SQL_ADMIN_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group create \
              --resource-group eventhub-test-rg \
              --template-file ${{ env.TEMPLATE_FILE }} \
              --parameters infra/bicep/environments/test/main.bicepparam

      - name: Grant Key Vault access to managed identities
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            KV_ID=$(az keyvault list --resource-group eventhub-test-rg --query "[0].id" -o tsv)
            ROLE="Key Vault Secrets User"

            API_PRINCIPAL=$(az webapp identity show --resource-group eventhub-test-rg --name eventhub-test-api --query principalId -o tsv)
            az role assignment create \
              --assignee-object-id "$API_PRINCIPAL" \
              --assignee-principal-type ServicePrincipal \
              --role "$ROLE" --scope "$KV_ID" 2>/dev/null || echo "API role assignment already exists"

            FUNC_PRINCIPAL=$(az functionapp identity show --resource-group eventhub-test-rg --name eventhub-test-func --query principalId -o tsv)
            az role assignment create \
              --assignee-object-id "$FUNC_PRINCIPAL" \
              --assignee-principal-type ServicePrincipal \
              --role "$ROLE" --scope "$KV_ID" 2>/dev/null || echo "Function App role assignment already exists"

  # ── Deploy to prod on manual trigger only ────────────────────────────────
  deploy-prod:
    name: Deploy – prod
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - name: Verify branch is master
        if: github.ref != 'refs/heads/master'
        run: |
          echo "Prod deployments must be triggered from master, not ${{ github.ref }}"
          exit 1

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure resource group exists
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
              az group create --name eventhub-prod-rg --location ${{ env.AZURE_LOCATION }}

      - name: Deploy – prod
        uses: azure/cli@v2
        env:
          SQL_ADMIN_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
        with:
          azcliversion: latest
          inlineScript: |
            az deployment group create \
              --resource-group eventhub-prod-rg \
              --template-file ${{ env.TEMPLATE_FILE }} \
              --parameters infra/bicep/environments/prod/main.bicepparam

      - name: Grant Key Vault access to managed identities
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            KV_ID=$(az keyvault list --resource-group eventhub-prod-rg --query "[0].id" -o tsv)
            ROLE="Key Vault Secrets User"

            API_PRINCIPAL=$(az webapp identity show --resource-group eventhub-prod-rg --name eventhub-prod-api --query principalId -o tsv)
            az role assignment create \
              --assignee-object-id "$API_PRINCIPAL" \
              --assignee-principal-type ServicePrincipal \
              --role "$ROLE" --scope "$KV_ID" 2>/dev/null || echo "API role assignment already exists"

            FUNC_PRINCIPAL=$(az functionapp identity show --resource-group eventhub-prod-rg --name eventhub-prod-func --query principalId -o tsv)
            az role assignment create \
              --assignee-object-id "$FUNC_PRINCIPAL" \
              --assignee-principal-type ServicePrincipal \
              --role "$ROLE" --scope "$KV_ID" 2>/dev/null || echo "Function App role assignment already exists"
